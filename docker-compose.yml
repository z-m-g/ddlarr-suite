services:
  # Torznab Indexer - provides search API for Radarr/Sonarr
  ddl-torznab:
    build: ./indexer
    container_name: ddl-torznab
    ports:
      - "${INDEXER_PORT:-9117}:${INDEXER_PORT:-9117}"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${INDEXER_PORT:-9117}
      - WAWACITY_URL=${WAWACITY_URL}
      - ZONETELECHARGER_URL=${ZONETELECHARGER_URL}
      # - DARKIWORLD_URL=${DARKIWORLD_URL}  # Disabled - not fully implemented
      # - DARKIWORLD_API_KEY=${DARKIWORLD_API_KEY}
      - DLPROTECT_SERVICE_URL=http://dlprotect-resolver:${DLPROTECT_RESOLVER_PORT:-5000}
      - DLPROTECT_RESOLVE_AT=${DLPROTECT_RESOLVE_AT:-indexer}
    depends_on:
      dlprotect-resolver:
        condition: service_healthy
    restart: unless-stopped

  # Botasaurus service for dl-protect resolution
  dlprotect-resolver:
    build: ./botasaurus-service
    container_name: dlprotect-resolver
    ports:
      - "${DLPROTECT_RESOLVER_PORT:-5000}:${DLPROTECT_RESOLVER_PORT:-5000}"
    environment:
      - PYTHONUNBUFFERED=1
      - CACHE_DIR=/app/cache
      - PORT=${DLPROTECT_RESOLVER_PORT:-5000}
      - DEBUG=${DEBUG:-false}
    volumes:
      - ./cache:/app/cache
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${DLPROTECT_RESOLVER_PORT:-5000}/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # DDL Downloader - watches blackhole folder and sends to download clients
  ddl-downloader:
    build: ./downloader
    container_name: ddl-downloader
    ports:
      - "${DOWNLOADER_PORT:-9118}:${DOWNLOADER_PORT:-9118}"
    depends_on:
      dlprotect-resolver:
        condition: service_healthy
    environment:
      - PORT=${DOWNLOADER_PORT:-9118}
      - CONFIG_PATH=/config/config.json
      - BLACKHOLE_PATH=/blackhole
      - PROCESSED_PATH=/blackhole/processed
      - DLPROTECT_SERVICE_URL=http://dlprotect-resolver:${DLPROTECT_RESOLVER_PORT:-5000}
      - DLPROTECT_RESOLVE_AT=${DLPROTECT_RESOLVE_AT:-indexer}
      - DEBUG=${DEBUG:-false}
      # Debrid Services (multiple services can be enabled - fallback in order)
      - ALLDEBRID_ENABLED=${ALLDEBRID_ENABLED:-false}
      - ALLDEBRID_API_KEY=${ALLDEBRID_API_KEY:-}
      - REALDEBRID_ENABLED=${REALDEBRID_ENABLED:-false}
      - REALDEBRID_API_KEY=${REALDEBRID_API_KEY:-}
      - PREMIUMIZE_ENABLED=${PREMIUMIZE_ENABLED:-false}
      - PREMIUMIZE_API_KEY=${PREMIUMIZE_API_KEY:-}
      # Download Station
      - DS_ENABLED=${DS_ENABLED:-false}
      - DS_HOST=${DS_HOST:-}
      - DS_PORT=${DS_PORT:-5000}
      - DS_USERNAME=${DS_USERNAME:-}
      - DS_PASSWORD=${DS_PASSWORD:-}
      - DS_USE_SSL=${DS_USE_SSL:-false}
      - DS_DESTINATION=${DS_DESTINATION:-}
      # JDownloader
      - JD_ENABLED=${JD_ENABLED:-false}
      - JD_API_MODE=${JD_API_MODE:-auto}
      - JD_LOCAL_HOST=${JD_LOCAL_HOST:-}
      - JD_LOCAL_PORT=${JD_LOCAL_PORT:-3128}
      - JD_EMAIL=${JD_EMAIL:-}
      - JD_PASSWORD=${JD_PASSWORD:-}
      - JD_DEVICE=${JD_DEVICE:-}
      # aria2
      - ARIA2_ENABLED=${ARIA2_ENABLED:-false}
      - ARIA2_HOST=${ARIA2_HOST:-localhost}
      - ARIA2_PORT=${ARIA2_PORT:-6800}
      - ARIA2_SECRET=${ARIA2_SECRET:-}
      - ARIA2_DIR=${ARIA2_DIR:-}
      # pyLoad
      - PYLOAD_ENABLED=${PYLOAD_ENABLED:-false}
      - PYLOAD_HOST=${PYLOAD_HOST:-localhost}
      - PYLOAD_PORT=${PYLOAD_PORT:-8000}
      - PYLOAD_USERNAME=${PYLOAD_USERNAME:-}
      - PYLOAD_PASSWORD=${PYLOAD_PASSWORD:-}
      - PYLOAD_USE_SSL=${PYLOAD_USE_SSL:-false}
      # curl (direct download)
      - CURL_ENABLED=${CURL_ENABLED:-false}
      - CURL_DESTINATION=${CURL_DESTINATION:-/downloads}
      # wget (direct download)
      - WGET_ENABLED=${WGET_ENABLED:-false}
      - WGET_DESTINATION=${WGET_DESTINATION:-/downloads}
    volumes:
      - ${DOWNLOADER_CONFIG_PATH:-./downloader-config}:/config
      - ${BLACKHOLE_PATH:-./blackhole}:/blackhole
      - ${DOWNLOADS_PATH:-./downloads}:/downloads
    restart: unless-stopped

  # DDL-qBittorrent - qBittorrent-compatible API for Sonarr/Radarr integration
  ddl-qbittorrent:
    build: ./qbittorrent
    container_name: ddl-qbittorrent
    ports:
      - "${QBITTORRENT_PORT:-8080}:8080"
    depends_on:
      dlprotect-resolver:
        condition: service_healthy
    environment:
      - PORT=8080
      - DATA_PATH=/data
      - DOWNLOAD_PATH=/downloads
      - TEMP_PATH=/downloads-temp
      - DLPROTECT_SERVICE_URL=http://dlprotect-resolver:${DLPROTECT_RESOLVER_PORT:-5000}
      # Authentication
      - QB_USERNAME=${QB_USERNAME:-admin}
      - QB_PASSWORD=${QB_PASSWORD:-adminadmin}
      # Download settings
      - MAX_CONCURRENT_DOWNLOADS=${MAX_CONCURRENT_DOWNLOADS:-3}
      # Debrid Services
      - ALLDEBRID_ENABLED=${ALLDEBRID_ENABLED:-false}
      - ALLDEBRID_API_KEY=${ALLDEBRID_API_KEY:-}
      - REALDEBRID_ENABLED=${REALDEBRID_ENABLED:-false}
      - REALDEBRID_API_KEY=${REALDEBRID_API_KEY:-}
      - PREMIUMIZE_ENABLED=${PREMIUMIZE_ENABLED:-false}
      - PREMIUMIZE_API_KEY=${PREMIUMIZE_API_KEY:-}
    volumes:
      - ${QBITTORRENT_DATA_PATH:-./qbittorrent-data}:/data
      - ${DOWNLOADS_PATH:-./downloads}:/downloads
      - ${DOWNLOADS_TEMP_PATH:-./downloads-temp}:/downloads-temp
    restart: unless-stopped
